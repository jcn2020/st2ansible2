---
version: 1.0
description: quick demo of ansible

input:
  - private_keypath: 'nil'
#  - runcmd_keypath: "/opt/stackstorm/packs/sre_asible2_automation/artifacts/key_fullaccess"
  - inventory_file
  - playbook
  - datastore_key 

vars:
  - results: 'nil'
  - tmp_key: "/tmp/tmp_key"

output:
  - final: <% ctx().results %> 

tasks:
  write_private_key:
    action: core.local
    input:
      cmd: |-
        
        ls -altr /tmp
        if [ -e <% ctx().tmp_key %> ]; then
          echo "found old <% ctx().tmp_key %> file, removing it" 
          cat <% ctx().tmp_key %>
          sudo rm -f <% ctx().tmp_key %>
          sudo rm -f /tmp/junk2 /tmp/junk3 /tmp/junk4
        fi
        echo -n "<% ctx().datastore_key %>" > <% ctx().tmp_key %>
        echo "wrote private key to <% ctx().private_keypath %>"
        echo "current pwd"
        pwd 
        echo "ls -altr" 
        ls -altr  
        echo "ls -altr /tmp"
        ls -altr /tmp 
        whoami 
        echo "ls -altr /tmp here"
        ls -altr /tmp
        cat <% ctx().tmp_key %>
         

    next:
      - when: <% succeeded() %>
        publish:
          - private_keypath: "<% ctx().tmp_key %>"
          - results: 'so far so good'
        do:
          - chmod_key
      - when: <% failed() %>
        publish:
          - private_keypath: "failed to write private key" 
          - results: "failed to write private key"
          
        
  chmod_key:
    action: core.local
    input:
      cmd: |
        sudo chmod 0400 <% ctx().private_keypath %>
        ls -altr <% ctx().private_keypath %>
        echo "private key path is <% ctx().private_keypath %>"
        cat <% ctx().private_keypath %>

    next:
      - when: <% succeeded() %>
        do:
          - run_cmd
          - run_ansible
      - when: <% failed() %>
        publish:
          - results: "chmod failed"

  run_cmd:
    action: core.local
    input:
      cmd: "ansible myhosts -m ping -i <% ctx().inventory_file %> -e ansible_ssh_private_key_file=<% ctx().private_keypath %>"
      # cmd: "ansible myhosts -m ping -i <% ctx().inventory_file %> -e ansible_ssh_private_key_file=<% ctx().runcmd_keypath %>"
      # cmd: "/opt/stackstorm/virtualenvs/ansible/bin/ansible-playbook --private-key=/opt/stackstorm/packs/sre_asible_automation/artifacts/key --inventory-file=/opt/stackstorm/packs/sre_asible_automation/artifacts/inventory.yaml --become /opt/stackstorm/packs/sre_ansible_automation/artifacts/playbook1.yaml" 
      # cmd: "pwd && cd /opt/stackstorm/packs/sre_ansible_automation/artifacts && ls -altr"
      # cmd: "echo 'hello'"
    next:
      - when: <% succeeded() %>
        publish:
          - results: "<% task(run_cmd).result %>"
          # - results: "passing"
        do:
          - set_results
      - when: <% failed() %>
        publish:
          - results: "that's all folks" 

  set_results:
    action: core.noop
    next: 
      - when: <% succeeded() %> 
        publish:
          - results: "<% task(run_cmd).result %>"
          # - results: "passing #2"
      - when: <% failed() %> 
        publish: 
          - results: "Task failed, no output available"

  run_ansible:
    action: ansible.playbook
    input: 
      private_key: <% ctx().private_keypath %>
      inventory_file: <% ctx().inventory_file %>
      playbook: "<% ctx().playbook %>"
      debug: true
      become: true
      timeout: 7200 
      extra_vars:
        - ansible_ssh_private_key_file: "<% ctx().private_keypath %>"
    retry: 
      when: <% failed() %>
      count: 1
      delay: 10
    next:
      - when: <% succeeded() %>
        publish:
          - results: "<% task(run_ansible).result %>"
      - when: <% failed() %>
        publish: 
          - results: "Task failed, no output available"

